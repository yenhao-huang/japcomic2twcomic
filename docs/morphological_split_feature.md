# Morphological Split åŠŸèƒ½æ–‡æª”

## æ¦‚è¿°

åœ¨ `text_mask_render_refactor.py` ä¸­å¯¦ç¾äº† **Morphological Split** åŠŸèƒ½ï¼Œç”¨æ–¼å°‡é€£åœ¨ä¸€èµ·çš„å¤šå€‹å°è©±æ¡†ï¼ˆspeech bubblesï¼‰è‡ªå‹•åˆ†é›¢ï¼Œä¸¦æ ¹æ“šå€åŸŸå¤§å°æ™ºèƒ½åˆ†é…ç¿»è­¯æ–‡å­—ã€‚

## å•é¡ŒèƒŒæ™¯

åœ¨æ¼«ç•«ç¿»è­¯ä¸­ï¼Œç¶“å¸¸æœƒé‡åˆ°ä»¥ä¸‹æƒ…æ³ï¼š
- å¤šå€‹å°è©±æ¡†åœ¨ segmentation mask ä¸­é€£åœ¨ä¸€èµ·å½¢æˆä¸€å¡Šå€åŸŸ
- ä¸€å€‹ç¿»è­¯æ–‡å­—éœ€è¦åˆ†é…åˆ°å¤šå€‹ç¨ç«‹çš„å°è©±æ¡†ä¸­
- éœ€è¦æ ¹æ“šæ¯å€‹å°è©±æ¡†çš„å¤§å°å’Œå½¢ç‹€ä¾†åˆç†åˆ†é…æ–‡å­—å…§å®¹

**ç¤ºä¾‹**ï¼š9 å€‹åŸå§‹ region ç¶“éè™•ç†å¾Œå¯èƒ½è®Šæˆ 15 å€‹ç¨ç«‹çš„ region

## åŠŸèƒ½å¯¦ç¾

### 1. æ ¸å¿ƒæ–¹æ³•

#### `_split_connected_regions(mask: np.ndarray) -> List[np.ndarray]`

**åŠŸèƒ½**ï¼šä½¿ç”¨å½¢æ…‹å­¸æ“ä½œåˆ†é›¢é€£åœ¨ä¸€èµ·çš„ speech bubbles

**è™•ç†æµç¨‹**ï¼š
1. ä½¿ç”¨ `cv2.connectedComponents()` é€²è¡Œé€£é€šçµ„ä»¶åˆ†æ
2. å¦‚æœåªæœ‰ä¸€å€‹é€£é€šçµ„ä»¶ï¼Œèª¿ç”¨ `_morphological_split()` é€²ä¸€æ­¥åˆ†é›¢
3. æŒ‰å€åŸŸå¤§å°æ’åºï¼ˆå¾å¤§åˆ°å°ï¼‰

**ç¤ºä¾‹**ï¼š
```python
# è¼¸å…¥ï¼šä¸€å€‹åŒ…å«å¤šå€‹é€£æ¥å°è©±æ¡†çš„ mask
mask = segmentation_mask  # shape: (H, W)

# è¼¸å‡ºï¼šåˆ†é›¢å¾Œçš„å¤šå€‹ç¨ç«‹ mask
split_regions = renderer._split_connected_regions(mask)
# split_regions: [mask1, mask2, mask3, ...]
```

---

#### `_morphological_split(mask: np.ndarray) -> List[np.ndarray]`

**åŠŸèƒ½**ï¼šä½¿ç”¨è…è•-è†¨è„¹æ“ä½œåˆ†é›¢å–®ä¸€å¤§å€åŸŸ

**è™•ç†æµç¨‹**ï¼š
1. **è¨ˆç®— kernel size**ï¼š`kernel_size = max(5, int(sqrt(mask_area) / 15))`
2. **è…è•**ï¼šä½¿ç”¨æ©¢åœ“å½¢ kernelï¼Œè¿­ä»£ 3 æ¬¡
3. **é€£é€šçµ„ä»¶åˆ†æ**ï¼šæ‰¾å‡ºåˆ†é›¢å¾Œçš„å¤šå€‹å€åŸŸ
4. **è†¨è„¹**ï¼šå°‡æ¯å€‹å€åŸŸæ¢å¾©åˆ°åŸå§‹å¤§å°
5. **éæ¿¾**ï¼šç§»é™¤å¤ªå°çš„å€åŸŸï¼ˆ< 100 åƒç´ ï¼‰

**é—œéµåƒæ•¸**ï¼š
- `kernel_size`ï¼šæ ¹æ“šå€åŸŸé¢ç©å‹•æ…‹è¨ˆç®—
- `iterations=3`ï¼šè…è•è¿­ä»£æ¬¡æ•¸ï¼Œè¶Šå¤§åˆ†é›¢æ•ˆæœè¶Šå¼·
- `min_area=100`ï¼šéæ¿¾é–¾å€¼

---

#### `_assign_text_to_regions(text: str, regions: List[np.ndarray]) -> List[tuple]`

**åŠŸèƒ½**ï¼šæ ¹æ“šå€åŸŸå¤§å°å’Œæ›è¡Œç¬¦è™Ÿå°‡æ–‡å­—åˆ†é…åˆ°å„å€‹å€åŸŸ

**è™•ç†é‚è¼¯**ï¼š

1. **å„ªå…ˆä½¿ç”¨æ›è¡Œç¬¦åˆ†å‰²**ï¼š
   ```python
   "ç¬¬ä¸€å€‹å°è©±æ¡†\nç¬¬äºŒå€‹å°è©±æ¡†" -> ["ç¬¬ä¸€å€‹å°è©±æ¡†", "ç¬¬äºŒå€‹å°è©±æ¡†"]
   ```

2. **ç„¡æ›è¡Œç¬¦æ™‚ï¼ŒæŒ‰å€åŸŸå¤§å°æ¯”ä¾‹åˆ†é…**ï¼š
   - è¨ˆç®—æ¯å€‹å€åŸŸçš„é¢ç©æ¯”ä¾‹
   - æ ¹æ“šæ¯”ä¾‹åˆ†é…å­—å…ƒæ•¸
   - è¼ƒå¤§å€åŸŸåˆ†é…æ›´å¤šæ–‡å­—

3. **è™•ç†æ•¸é‡ä¸åŒ¹é…**ï¼š
   - å¦‚æœæ–‡å­—éƒ¨åˆ† > å€åŸŸæ•¸ï¼šå¤šé¤˜æ–‡å­—åˆä½µåˆ°æœ€å¾Œä¸€å€‹å€åŸŸ
   - å¦‚æœæ–‡å­—éƒ¨åˆ† < å€åŸŸæ•¸ï¼šå‰©é¤˜å€åŸŸä¿æŒç©ºç™½

**ç¤ºä¾‹**ï¼š
```python
# å ´æ™¯ 1: ä½¿ç”¨æ›è¡Œç¬¦åˆ†å‰²
text = "ä½ å¥½\nä¸–ç•Œ"
regions = [region1, region2]
# çµæœ: [(region1, "ä½ å¥½"), (region2, "ä¸–ç•Œ")]

# å ´æ™¯ 2: æŒ‰å¤§å°æ¯”ä¾‹åˆ†é…
text = "é€™æ˜¯ä¸€æ®µå¾ˆé•·çš„æ–‡å­—å…§å®¹"
regions = [large_region, small_region]  # é¢ç©æ¯”ä¾‹ 7:3
# çµæœ: [(large_region, "é€™æ˜¯ä¸€æ®µå¾ˆé•·çš„"), (small_region, "æ–‡å­—å…§å®¹")]
```

---

#### `_split_text_by_region_sizes(text: str, regions: List[np.ndarray]) -> List[str]`

**åŠŸèƒ½**ï¼šæ ¹æ“šå€åŸŸå¤§å°æ¯”ä¾‹åˆ†å‰²æ–‡å­—

**è¨ˆç®—å…¬å¼**ï¼š
```python
region_proportion = region_area / total_area
char_count = text_length Ã— region_proportion
```

---

## ä½¿ç”¨ç¤ºä¾‹

### åœ¨ `render_text_in_each_region` ä¸­çš„æ•´åˆ

```python
def render_text_in_each_region(self, img: Image.Image,
                               segmentation_mask: np.ndarray,
                               translated_text: str) -> Image.Image:
    # 1. åˆ†é›¢é€£æ¥çš„å€åŸŸ
    split_regions = self._split_connected_regions(mask)
    print(f"åˆ†é›¢å¾Œå€åŸŸæ•¸: {len(split_regions)}")

    # 2. æ ¹æ“šå€åŸŸå¤§å°åˆ†é…æ–‡å­—
    text_assignments = self._assign_text_to_regions(translated_text, split_regions)

    # 3. ç‚ºæ¯å€‹å€åŸŸæ¸²æŸ“å°æ‡‰çš„æ–‡å­—
    for region_mask, region_text in text_assignments:
        if region_text.strip():
            self._render_text_in_mask(draw, region_text, region_mask)
```

---

## æ¸¬è©¦çµæœ

### æ¸¬è©¦æ¡ˆä¾‹ï¼šå…©å€‹é€£æ¥çš„å°è©±æ¡†

**è¼¸å…¥**ï¼š
- åŸå§‹ maskï¼š1 å€‹é€£æ¥çš„å€åŸŸï¼ˆ35,485 åƒç´ ï¼‰
- é€£æ¥æ–¹å¼ï¼šç´°é•·çš„é€£æ¥éƒ¨åˆ†

**è¼¸å‡º**ï¼š
- æˆåŠŸåˆ†é›¢ç‚º 2 å€‹å€åŸŸ
  - å€åŸŸ 1ï¼š17,152 åƒç´ ï¼ˆè¼ƒå¤§ï¼Œä¸Šæ–¹ï¼‰
  - å€åŸŸ 2ï¼š11,102 åƒç´ ï¼ˆè¼ƒå°ï¼Œä¸‹æ–¹ï¼‰

**è¦–è¦ºåŒ–**ï¼š
```
åŸå§‹ (ç™½è‰²)          åˆ†é›¢çµæœ
   âšª               ğŸ”´ (å€åŸŸ1)
    |
    |
   âšª               ğŸŸ¢ (å€åŸŸ2)
```

æ¸¬è©¦æ–‡ä»¶ï¼š`tests/test_morphological_split_simple.py`

---

## åƒæ•¸èª¿æ•´å»ºè­°

### Kernel Size
```python
# ä¿å®ˆï¼ˆåˆ†é›¢è¼ƒå°‘ï¼‰
kernel_size = max(3, int(sqrt(area) / 20))

# ç©æ¥µï¼ˆåˆ†é›¢è¼ƒå¤šï¼‰- ç•¶å‰è¨­å®š
kernel_size = max(5, int(sqrt(area) / 15))

# éå¸¸ç©æ¥µï¼ˆå¯èƒ½éåº¦åˆ†é›¢ï¼‰
kernel_size = max(7, int(sqrt(area) / 10))
```

### è…è•è¿­ä»£æ¬¡æ•¸
```python
iterations = 2  # è¼•åº¦åˆ†é›¢
iterations = 3  # ä¸­åº¦åˆ†é›¢ï¼ˆç•¶å‰è¨­å®šï¼‰
iterations = 4  # å¼·åº¦åˆ†é›¢
```

### æœ€å°å€åŸŸé¢ç©
```python
min_area = 100   # ç•¶å‰è¨­å®š
min_area = 200   # æ›´åš´æ ¼éæ¿¾
min_area = 50    # ä¿ç•™æ›´å¤šå°å€åŸŸ
```

---

## å„ªé»

1. **è‡ªå‹•åŒ–è™•ç†**ï¼šç„¡éœ€æ‰‹å‹•æ¨™è¨»æ¯å€‹å°è©±æ¡†
2. **æ™ºèƒ½æ–‡å­—åˆ†é…**ï¼šæ ¹æ“šå€åŸŸå¤§å°åˆç†åˆ†é…æ–‡å­—
3. **æ”¯æŒæ›è¡Œç¬¦**ï¼šå°Šé‡ç¿»è­¯ä¸­çš„æ›è¡Œçµæ§‹
4. **å‹•æ…‹åƒæ•¸**ï¼škernel size æ ¹æ“šå€åŸŸå¤§å°è‡ªå‹•èª¿æ•´
5. **é­¯æ£’æ€§**ï¼šè™•ç†å„ç¨®é€£æ¥æƒ…æ³

---

## é™åˆ¶èˆ‡æœªä¾†æ”¹é€²

### ç•¶å‰é™åˆ¶
1. å°æ–¼éå¸¸ç·Šå¯†é€£æ¥çš„å€åŸŸå¯èƒ½ç„¡æ³•åˆ†é›¢
2. æ–‡å­—åˆ†é…åŸºæ–¼é¢ç©æ¯”ä¾‹ï¼Œä¸è€ƒæ…®é–±è®€é †åº
3. ç„¡æ³•è™•ç†åµŒå¥—æˆ–é‡ç–Šçš„å°è©±æ¡†

### æœªä¾†æ”¹é€²æ–¹å‘
1. **åŸºæ–¼æ–¹å‘çš„åˆ†é›¢**ï¼šè€ƒæ…®å°è©±æ¡†çš„ç©ºé–“ä½ç½®å’Œé–±è®€é †åº
2. **æ·±åº¦å­¸ç¿’åˆ†é›¢**ï¼šä½¿ç”¨ç¥ç¶“ç¶²çµ¡é€²è¡Œæ›´ç²¾ç¢ºçš„åˆ†é›¢
3. **æ–‡å­—é•·åº¦é æ¸¬**ï¼šæ ¹æ“šæ¸²æŸ“å¾Œçš„å¯¦éš›æ–‡å­—é•·åº¦å‹•æ…‹èª¿æ•´åˆ†é…
4. **ç”¨æˆ¶å¯é…ç½®åƒæ•¸**ï¼šå…è¨±é€šéé…ç½®æ–‡ä»¶èª¿æ•´åˆ†é›¢å¼·åº¦

---

## å®Œæ•´å·¥ä½œæµç¨‹

```
åŸå§‹è³‡æ–™
  â””â”€ load_data()
      â””â”€ List[ImgInfo]
          â””â”€ process_render()
              â””â”€ TextMaskBasedRenderer()
                  â””â”€ render_image_single()
                      â””â”€ render_text_in_each_region()
                          â”œâ”€ _split_connected_regions() âœ¨ æ–°å¢
                          â”‚   â””â”€ _morphological_split()
                          â”œâ”€ _assign_text_to_regions() âœ¨ æ–°å¢
                          â”‚   â””â”€ _split_text_by_region_sizes()
                          â””â”€ _render_text_in_mask()
```

---

## ä½¿ç”¨ç¯„ä¾‹

```bash
# ä½¿ç”¨æ–°åŠŸèƒ½é€²è¡Œæ¸²æŸ“
python -m lib.render.text_mask_render_refactor \
    --text_mask results/text_mask/yolo/text_mask.json \
    --translation results/translation/hunyuan.json \
    --output results/render/ \
    --font /path/to/font.ttf

# æŸ¥çœ‹åˆ†é›¢æ•ˆæœ
# åœ¨è¼¸å‡ºæ—¥èªŒä¸­æœƒé¡¯ç¤ºï¼š
# "åˆ†é›¢å¾Œå€åŸŸæ•¸: 2 (åŸå§‹: 1)"
```

---

## ç¸½çµ

Morphological Split åŠŸèƒ½ç‚ºæ¼«ç•«ç¿»è­¯æ¸²æŸ“æµç¨‹å¢åŠ äº†æ™ºèƒ½çš„å€åŸŸåˆ†é›¢å’Œæ–‡å­—åˆ†é…èƒ½åŠ›ï¼Œä½¿å¾—ç¿»è­¯çµæœæ›´åŠ è‡ªç„¶å’Œæº–ç¢ºã€‚é€šéå½¢æ…‹å­¸æ“ä½œè‡ªå‹•è­˜åˆ¥ä¸¦åˆ†é›¢é€£æ¥çš„å°è©±æ¡†ï¼Œç„¶å¾Œæ ¹æ“šå€åŸŸç‰¹å¾µæ™ºèƒ½åˆ†é…æ–‡å­—å…§å®¹ï¼Œå¤§å¤§æå‡äº†æ¸²æŸ“è³ªé‡å’Œè‡ªå‹•åŒ–ç¨‹åº¦ã€‚
